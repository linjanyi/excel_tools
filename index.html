<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Excel è¬èƒ½å·¥å…·ç®± - ç€è¦½å™¨æ ¼å¼è½‰æ›å°ˆæ¥­ç‰ˆ</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: #f0f2f5; padding: 20px; }
        .card { max-width: 750px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        h2 { color: #007bff; text-align: center; margin-bottom: 20px; }
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .tab { flex: 1; text-align: center; padding: 12px; cursor: pointer; font-weight: bold; color: #888; transition: 0.3s; }
        .tab.active { color: #007bff; border-bottom: 3px solid #007bff; background: #f8fbff; }
        .field-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        select, input[type="number"], input[type="file"] { width: 100%; padding: 10px; border: 1px solid #ccd0d5; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        .row { display: flex; gap: 15px; }
        .row .field-group { flex: 1; }
        .checkbox-group { display: flex; align-items: center; background: #e9ecef; padding: 10px 15px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; }
        .checkbox-group input { width: 18px; height: 18px; margin-right: 10px; }
        .info-box { background: #e8f4fd; color: #2c3e50; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; border-left: 4px solid #3498db; line-height: 1.6; }
        button { width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        button:hover { background: #218838; }
        #log { margin-top: 20px; font-size: 14px; color: #444; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #007bff; white-space: pre-line; }
        .highlight { color: #d9534f; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <h2 id="mainTitle">ğŸ“Š Excel è¬èƒ½å·¥å…·ç®±</h2>
    
    <div class="tabs">
        <div class="tab active" onclick="switchMode('split')">âœ‚ï¸ åˆ†å‰²/åˆä½µ/æ¸…æ´—</div>
        <div class="tab" onclick="switchMode('transform')">ğŸ”„ æ ¼å¼è½‰æ›</div>
    </div>
    
    <div class="field-group">
        <label id="fileLabel">1. ä¸Šå‚³æª”æ¡ˆ (å¯å¤šé¸)</label>
        <input type="file" id="upload" accept=".xlsx, .xls" multiple />
    </div>

    <div id="splitUI">
        <div class="row">
            <div class="field-group">
                <label>2. ä¿ç•™æ¨™é¡Œåˆ—æ•¸</label>
                <input type="number" id="headerRows" value="2" min="1" />
            </div>
            <div class="field-group">
                <label>3. æ¯ä»½ç­†æ•¸ (0=ä¸åˆ†å‰²)</label>
                <input type="number" id="rowsPerFile" value="0" min="0" />
            </div>
        </div>
        <div class="checkbox-group" onclick="document.getElementById('doUnique').click()">
            <input type="checkbox" id="doUnique" checked onclick="event.stopPropagation()">
            <label>è‡ªå‹•å»é™¤é‡è¤‡ (æ•´åˆ—ç›¸åŒæ‰åˆªé™¤)</label>
        </div>
        <div class="checkbox-group" onclick="document.getElementById('removeBlank').click()">
            <input type="checkbox" id="removeBlank" checked onclick="event.stopPropagation()">
            <label>è‡ªå‹•å‰”é™¤ç©ºç™½åˆ—</label>
        </div>
        <div class="info-box">
            <strong>âœ¨ è‡ªå‹•æ¸…æ´—åŠŸèƒ½å·²å•Ÿå‹•ï¼š</strong><br>
            â€¢ åˆä½µæ™‚å°‡è‡ªå‹•æ¸…ç©ºç¬¬ä¸€åˆ— <span class="highlight">U æ¬„ (ç¬¬21æ¬„) åŠä¹‹å¾Œ</span> çš„æ¨™é¡Œã€‚<br>
            â€¢ <span class="highlight">ç¬¬äºŒåˆ—èªªæ˜æ–‡å­—</span> å°‡æœƒå®Œæ•´ä¿ç•™ã€‚
        </div>
    </div>

    <div id="transformUI" style="display:none;">
        <div class="field-group">
            <label>2. é¸æ“‡è½‰æ›æ¨¡å¼</label>
            <select id="transMode">
                <option value="bitToAds">æ¯”ç‰¹è½‰ Ads (BitBrowser â†’ AdsPower)</option>
                <option value="adsToBit">Ads è½‰æ¯”ç‰¹ (AdsPower â†’ BitBrowser)</option>
            </select>
        </div>
        <div class="info-box">
            <strong>ğŸ“ è½‰æ›è¦å‰‡èªªæ˜ï¼š</strong><br>
            â€¢ <b>æ¯”ç‰¹è½‰ Adsï¼š</b>è‡ªå‹•æå–ã€Œçª—å£åç¨±(æˆ–Browser Name)ã€å‚™è¨»ã€Cookieã€Uæ¬„ã€å°æ‡‰è‡³ Ads æ ¼å¼ã€‚<br>
            â€¢ <b>Ads è½‰æ¯”ç‰¹ï¼š</b>å»ºç«‹æ¯”ç‰¹é›™æ¨™é¡Œã€‚ç¬¬ä¸€åˆ—æ¨™é¡Œåƒ…ä¿ç•™è‡³ T æ¬„ (ID)ï¼Œ<span class="highlight">U æ¬„ä»¥å¾Œç¬¬ä¸€åˆ—ä¸ç•™æ¨™é¡Œ</span>ï¼Œç¬¬äºŒåˆ—ä¿ç•™ç³»çµ±èªªæ˜ã€‚
        </div>
    </div>
    
    <button onclick="executeAction()">é–‹å§‹åŸ·è¡Œä¸¦å°å‡º</button>
    
    <div id="log">ç­‰å¾…æ“ä½œ...</div>
</div>

<script>
let currentMode = 'split';

function switchMode(mode) {
    currentMode = mode;
    document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', (i === 0 && mode === 'split') || (i === 1 && mode === 'transform')));
    document.getElementById('splitUI').style.display = mode === 'split' ? 'block' : 'none';
    document.getElementById('transformUI').style.display = mode === 'transform' ? 'block' : 'none';
}

function getMMDD() {
    const now = new Date();
    return String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0');
}

function isRowBlank(row) {
    if (!row || row.length === 0) return true;
    return row.every(cell => !cell || String(cell).trim() === "");
}

async function executeAction() {
    const fileInput = document.getElementById('upload');
    const log = document.getElementById('log');
    if (fileInput.files.length === 0) { alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼"); return; }
    
    log.innerHTML = "âŒ› è™•ç†ä¸­...";
    const dateStr = getMMDD();

    if (currentMode === 'split') {
        await handleSplitMerge(fileInput, dateStr, log);
    } else {
        const transType = document.getElementById('transMode').value;
        if (transType === 'bitToAds') {
            await handleBitToAds(fileInput, dateStr, log);
        } else {
            await handleAdsToBit(fileInput, dateStr, log);
        }
    }
}

// --- æ¨¡å¼ï¼šåˆ†å‰² / åˆä½µ / æ¸…æ´— ---
async function handleSplitMerge(fileInput, dateStr, log) {
    const headerRows = parseInt(document.getElementById('headerRows').value) || 0;
    const rowsSetting = parseInt(document.getElementById('rowsPerFile').value) || 0;
    const doUnique = document.getElementById('doUnique').checked;
    const doRemoveBlank = document.getElementById('removeBlank').checked;

    let finalHeaders = [];
    let combinedBody = [];

    for (let i = 0; i < fileInput.files.length; i++) {
        const data = await fileInput.files[i].arrayBuffer();
        const workbook = XLSX.read(data);
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        if (i === 0) {
            let headers = jsonData.slice(0, headerRows);
            if (headers.length > 0 && headers[0]) {
                for (let idx = 20; idx < headers[0].length; idx++) {
                    headers[0][idx] = "";
                }
            }
            finalHeaders = headers;
        }
        
        let body = jsonData.slice(headerRows);
        if (doRemoveBlank) body = body.filter(row => !isRowBlank(row));
        combinedBody = combinedBody.concat(body);
    }

    if (doUnique) {
        const seen = new Set();
        combinedBody = combinedBody.filter(row => {
            const s = JSON.stringify(row);
            return seen.has(s) ? false : seen.add(s);
        });
    }

    saveExcelFinal(finalHeaders, combinedBody, rowsSetting, dateStr, log, "Processed");
}

// --- æ¨¡å¼ï¼šæ¯”ç‰¹è½‰ Ads ---
async function handleBitToAds(fileInput, dateStr, log) {
    const data = await fileInput.files[0].arrayBuffer();
    const workbook = XLSX.read(data);
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    const adsHeaders = [
        "acc_id", "id", "group", "name", "remark", "platform", 
        "username", "password", "fakey", "cookie", "proxytype", 
        "ipchecker", "proxy", "proxyurl", "proxyid", "ip", "countrycode", "ua", "device"
    ];

    const originalHeaders = jsonData[0] || []; 
    
    // å„ªå…ˆæœå°‹ã€Œçª—å£åç§°ã€ï¼Œæ‰¾ä¸åˆ°å‰‡ç›¸å®¹ã€ŒBrowser Nameã€
    let idxName = originalHeaders.indexOf("çª—å£åç§°");
    if (idxName === -1) idxName = originalHeaders.indexOf("Browser Name");
    
    // å„ªå…ˆæœå°‹ã€Œçª—å£å¤‡æ³¨ã€ï¼Œæ‰¾ä¸åˆ°å‰‡ç›¸å®¹ã€ŒRemarkã€
    let idxRemark = originalHeaders.indexOf("çª—å£å¤‡æ³¨");
    if (idxRemark === -1) idxRemark = originalHeaders.indexOf("Remark");
    
    const idxCookie = originalHeaders.indexOf("Cookie");
    const idxU = 20; // ç¬¬ 21 æ¬„ (U)

    let body = [];
    // æ¯”ç‰¹ç€è¦½å™¨å°å‡ºé€šå¸¸æœ‰ 2 åˆ—æ¨™é¡Œ/èªªæ˜ï¼Œå¾ç´¢å¼• 2 é–‹å§‹æŠ“è³‡æ–™
    for (let i = 2; i < jsonData.length; i++) {
        const row = jsonData[i];
        if (!row || isRowBlank(row)) continue;
        
        let newRow = new Array(19).fill("");
        // æ¬„ä½å°æ‡‰
        newRow[3] = idxName !== -1 ? (row[idxName] || "") : "";   // å°æ‡‰ Ads çš„ name
        newRow[4] = idxRemark !== -1 ? (row[idxRemark] || "") : ""; // å°æ‡‰ Ads çš„ remark
        newRow[9] = idxCookie !== -1 ? (row[idxCookie] || "") : ""; // å°æ‡‰ Ads çš„ cookie
        newRow[18] = row[idxU] || "";                               // å°æ‡‰ Ads çš„ device (Uæ¬„)
        
        body.push(newRow);
    }
    saveExcelFinal([adsHeaders], body, 0, dateStr, log, "BitToAds");
}

// --- æ¨¡å¼ï¼šAds è½‰æ¯”ç‰¹ ---
async function handleAdsToBit(fileInput, dateStr, log) {
    const data = await fileInput.files[0].arrayBuffer();
    const workbook = XLSX.read(data);
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    const bitHeader1 = ["çª—å£åç§°","åˆ†ç»„","è´¦å·å¹³å°","ç”¨æˆ·å","å¯†ç ","2FAç§˜é’¥","Cookie","æ‰“å¼€æŒ‡å®šç½‘å€","ä»£ç†ç±»å‹","ä»£ç†ä¿¡æ¯","IPæŸ¥è¯¢æ¸ é“","åˆ·æ–°URL","å›½å®¶/åœ°åŒºï¼ˆé’ˆå¯¹åŠ¨æ€IPï¼‰","å·/çœï¼ˆé’ˆå¯¹åŠ¨æ€IPï¼‰","åŸå¸‚ï¼ˆé’ˆå¯¹åŠ¨æ€IPï¼‰","çª—å£å¤‡æ³¨","User Agent","çª—å£å°ºå¯¸","åºå·","ID"];
    const bitHeader2 = ["è¯´æ˜ï¼š\næ­¤è¡¨ç‚ºå°å‡ºçª—å£æ•¸æ“š..."]; // ç°¡åŒ–é¡¯ç¤ºï¼Œå¯¦éš›ä»£ç¢¼ä¸­æ‡‰ä¿ç•™å®Œæ•´æ–‡å­—

    const originalHeaders = jsonData[0];
    const idxName = originalHeaders.indexOf("name");
    const idxCookie = originalHeaders.indexOf("cookie");
    const idxRemark = originalHeaders.indexOf("remark");
    const idxDevice = originalHeaders.indexOf("device");

    let body = [];
    for (let i = 1; i < jsonData.length; i++) {
        const row = jsonData[i];
        if (!row || isRowBlank(row)) continue;
        
        let newRow = new Array(21).fill("");
        newRow[0] = row[idxName] || "";    
        newRow[6] = row[idxCookie] || "";  
        newRow[15] = row[idxRemark] || ""; 
        newRow[20] = row[idxDevice] || ""; // è³‡æ–™å¡«åœ¨ U æ¬„
        body.push(newRow);
    }
    saveExcelFinal([bitHeader1, bitHeader2], body, 0, dateStr, log, "AdsToBit");
}

// --- é€šç”¨å°å‡ºé‚è¼¯ ---
async function saveExcelFinal(headers, body, rowsSetting, dateStr, log, prefix) {
    const total = body.length;
    
    if (rowsSetting === 0 || total <= rowsSetting) {
        const ws = XLSX.utils.aoa_to_sheet([...headers, ...body]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
        const buffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        saveAs(new Blob([buffer]), `${prefix}_${dateStr}_${total}.xlsx`);
        log.innerHTML = `âœ… ä¸‹è¼‰å®Œæˆï¼šå…± ${total} ç­†è³‡æ–™ã€‚`;
    } else {
        const zip = new JSZip();
        let fileCount = 0;
        for (let i = 0; i < total; i += rowsSetting) {
            fileCount++;
            const chunk = body.slice(i, i + rowsSetting);
            const ws = XLSX.utils.aoa_to_sheet([...headers, ...chunk]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            const buffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            zip.file(`${prefix}_${dateStr}_${chunk.length}_${fileCount}.xlsx`, buffer);
        }
        const content = await zip.generateAsync({ type: "blob" });
        saveAs(content, `${prefix}_${dateStr}_split_all.zip`);
        log.innerHTML = `âœ… å·²åˆ†å‰²ç‚º ${fileCount} ä»½ä¸¦æ‰“åŒ…ä¸‹è¼‰ã€‚`;
    }
}
</script>

</body>
</html>
