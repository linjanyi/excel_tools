<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Excel æ•´ç†å·¥å…· - è‡ªå®šç¾©æ¨™é¡Œåˆ—ç‰ˆ</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: #f0f2f5; padding: 40px; }
        .card { max-width: 500px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        h2 { color: #007bff; text-align: center; margin-bottom: 25px; }
        .field-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        input { width: 100%; padding: 12px; border: 1px solid #ccd0d5; border-radius: 8px; box-sizing: border-box; }
        .row { display: flex; gap: 10px; }
        .row .field-group { flex: 1; }
        button { width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        button:hover { background: #218838; }
        #log { margin-top: 20px; font-size: 14px; color: #666; padding: 10px; background: #f8f9fa; border-radius: 6px; }
        .status-success { color: #28a745; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ“Š Excel æ•¸æ“šåˆ†å‰²æ•´ç†</h2>
    
    <div class="field-group">
        <label>1. ä¸Šå‚³æª”æ¡ˆ</label>
        <input type="file" id="upload" accept=".xlsx, .xls" />
    </div>
    
    <div class="row">
        <div class="field-group">
            <label>2. ä¿ç•™æ¨™é¡Œåˆ—æ•¸</label>
            <input type="number" id="headerRows" value="2" min="1" />
        </div>
        <div class="field-group">
            <label>3. æ¯ä»½ç­†æ•¸ (0=ä¸åˆ†å‰²)</label>
            <input type="number" id="rowsPerFile" value="0" min="0" />
        </div>
    </div>
    
    <button onclick="processExcel()">é–‹å§‹è™•ç†</button>
    
    <div id="log">ç­‰å¾…æª”æ¡ˆä¸Šå‚³...</div>
</div>

<script>
function getMMDD() {
    const now = new Date();
    const m = String(now.getMonth() + 1).padStart(2, '0');
    const d = String(now.getDate()).padStart(2, '0');
    return m + d;
}

async function processExcel() {
    const fileInput = document.getElementById('upload');
    const headerRowsSetting = parseInt(document.getElementById('headerRows').value) || 0;
    const rowsVal = document.getElementById('rowsPerFile').value;
    const log = document.getElementById('log');
    
    if (!fileInput.files[0]) { alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼"); return; }

    const file = fileInput.files[0];
    const rowsSetting = parseInt(rowsVal) || 0; 
    const dateStr = getMMDD();
    
    log.innerHTML = "âŒ› è®€å–ä¸­...";

    const data = await file.arrayBuffer();
    const workbook = XLSX.read(data);
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    // æ ¹æ“šè¨­å®šåˆ†é›¢æ¨™é¡Œèˆ‡è³‡æ–™
    const headers = jsonData.slice(0, headerRowsSetting);
    const body = jsonData.slice(headerRowsSetting);
    const totalDataRows = body.length;

    if (jsonData.length <= headerRowsSetting) {
        log.innerHTML = `âŒ éŒ¯èª¤ï¼šæª”æ¡ˆè¡Œæ•¸ä¸è¶³ ${headerRowsSetting} è¡Œã€‚`;
        return;
    }

    const zip = new JSZip();

    if (rowsSetting === 0) {
        const fileName = `${dateStr}_${totalDataRows}`;
        addFileToZip(zip, [...headers, ...body], fileName);
        log.innerHTML = `æ¨¡å¼ï¼šä¸åˆ†å‰²ï¼Œå…± ${totalDataRows} ç­†è³‡æ–™ã€‚`;
    } else {
        let fileCount = 0;
        for (let i = 0; i < totalDataRows; i += rowsSetting) {
            fileCount++;
            const chunk = body.slice(i, i + rowsSetting);
            const fileName = `${dateStr}_${rowsSetting}_${fileCount}`;
            addFileToZip(zip, [...headers, ...chunk], fileName);
        }
        log.innerHTML = `æ¨¡å¼ï¼šæ¯ ${rowsSetting} ç­†åˆ†å‰²ï¼Œå…± ${fileCount} å€‹æª”æ¡ˆã€‚`;
    }

    const zipName = rowsSetting === 0 ? `${dateStr}_${totalDataRows}.zip` : `${dateStr}_${rowsSetting}.zip`;

    log.innerHTML += "<br>ğŸ“¦ æ­£åœ¨æ‰“åŒ… ZIP...";
    zip.generateAsync({ type: "blob" }).then(content => {
        saveAs(content, zipName);
        log.innerHTML = `<span class="status-success">âœ… å®Œæˆï¼å·²ä¸‹è¼‰ ${zipName}</span>`;
    });
}

function addFileToZip(zipInstance, data, fileName) {
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
    const buffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
    zipInstance.file(fileName + ".xlsx", buffer);
}
</script>

</body>
</html>
