<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Excel è¬èƒ½å·¥å…· - æ™ºæ…§ä¸‹è¼‰ç‰ˆ</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: #f0f2f5; padding: 20px; }
        .card { max-width: 600px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        h2 { color: #007bff; text-align: center; margin-bottom: 20px; }
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; font-weight: bold; color: #888; }
        .tab.active { color: #007bff; border-bottom: 2px solid #007bff; }
        .field-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        input[type="number"], input[type="file"] { width: 100%; padding: 10px; border: 1px solid #ccd0d5; border-radius: 8px; box-sizing: border-box; }
        .row { display: flex; gap: 15px; }
        .row .field-group { flex: 1; }
        .checkbox-group { display: flex; align-items: center; background: #e9ecef; padding: 10px 15px; border-radius: 8px; margin-bottom: 10px; }
        .checkbox-group input { width: 18px; height: 18px; margin-right: 10px; }
        .checkbox-group label { margin-bottom: 0; font-size: 14px; cursor: pointer; flex: 1; }
        button { width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background: #218838; }
        #log { margin-top: 20px; font-size: 14px; color: #444; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #007bff; white-space: pre-line; }
    </style>
</head>
<body>

<div class="card">
    <h2 id="mainTitle">ğŸ“Š Excel åˆ†å‰²å·¥å…·</h2>
    
    <div class="tabs">
        <div class="tab active" onclick="switchMode('split')">âœ‚ï¸ åˆ†å‰²æ¨¡å¼</div>
        <div class="tab" onclick="switchMode('merge')">ğŸ“‚ åˆä½µæ¨¡å¼</div>
    </div>
    
    <div class="field-group">
        <label id="fileLabel">1. ä¸Šå‚³æª”æ¡ˆ (å¯å¤šé¸)</label>
        <input type="file" id="upload" accept=".xlsx, .xls" multiple />
    </div>
    
    <div class="row">
        <div class="field-group">
            <label>2. ä¿ç•™æ¨™é¡Œåˆ—æ•¸</label>
            <input type="number" id="headerRows" value="2" min="1" />
        </div>
        <div class="field-group" id="splitSizeGroup">
            <label>3. æ¯ä»½ç­†æ•¸ (0=ä¸åˆ†å‰²)</label>
            <input type="number" id="rowsPerFile" value="0" min="0" />
        </div>
    </div>

    <div class="checkbox-group">
        <input type="checkbox" id="doUnique" checked>
        <label for="doUnique">è‡ªå‹•å»é™¤é‡è¤‡ (æ•´åˆ—ç›¸åŒæ‰åˆªé™¤)</label>
    </div>

    <div class="checkbox-group">
        <input type="checkbox" id="removeBlank" checked>
        <label for="removeBlank">è‡ªå‹•å‰”é™¤ç©ºç™½åˆ— (ç„¡å…§å®¹æˆ–åƒ…ç©ºæ ¼çš„åˆ—)</label>
    </div>
    
    <button id="btnAction" onclick="processExcel()">é–‹å§‹è™•ç†ä¸¦å°å‡º</button>
    
    <div id="log">ç­‰å¾…æ“ä½œ...</div>
</div>

<script>
let currentMode = 'split';

function switchMode(mode) {
    currentMode = mode;
    const tabs = document.querySelectorAll('.tab');
    tabs[0].classList.toggle('active', mode === 'split');
    tabs[1].classList.toggle('active', mode === 'merge');
    document.getElementById('mainTitle').innerText = mode === 'split' ? 'ğŸ“Š Excel åˆ†å‰²å·¥å…·' : 'ğŸ“‚ Excel åˆä½µå·¥å…·';
    document.getElementById('splitSizeGroup').style.display = mode === 'split' ? 'block' : 'none';
}

function getMMDD() {
    const now = new Date();
    return String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0');
}

function isRowBlank(row) {
    if (!row || row.length === 0) return true;
    return row.every(cell => cell === null || cell === undefined || String(cell).trim() === "");
}

function removeDuplicates(dataArray) {
    const seen = new Set();
    return dataArray.filter(row => {
        const s = JSON.stringify(row);
        return seen.has(s) ? false : seen.add(s);
    });
}

// å°‡ AOE è³‡æ–™è½‰æ›ç‚º Excel Buffer
function generateExcelBuffer(headers, body) {
    const ws = XLSX.utils.aoa_to_sheet([...headers, ...body]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
    return XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
}

async function processExcel() {
    const fileInput = document.getElementById('upload');
    const headerRows = parseInt(document.getElementById('headerRows').value) || 0;
    const rowsSetting = parseInt(document.getElementById('rowsPerFile').value) || 0;
    const doUnique = document.getElementById('doUnique').checked;
    const doRemoveBlank = document.getElementById('removeBlank').checked;
    const log = document.getElementById('log');
    
    if (fileInput.files.length === 0) { alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼"); return; }

    log.innerHTML = "âŒ› æ­£åœ¨è®€å–è³‡æ–™...";
    const dateStr = getMMDD();
    let finalHeaders = [];
    let combinedBody = [];

    for (let i = 0; i < fileInput.files.length; i++) {
        const data = await fileInput.files[i].arrayBuffer();
        const workbook = XLSX.read(data);
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        if (i === 0) finalHeaders = jsonData.slice(0, headerRows);
        let body = jsonData.slice(headerRows);
        
        if (doRemoveBlank) body = body.filter(row => !isRowBlank(row));
        combinedBody = combinedBody.concat(body);
    }

    if (doUnique) {
        const before = combinedBody.length;
        combinedBody = removeDuplicates(combinedBody);
        log.innerHTML = `âœ… å·²æ¸…ç†ï¼šå‰”é™¤ ${before - combinedBody.length} ç­†è³‡æ–™ã€‚`;
    }

    const total = combinedBody.length;
    
    // --- æ™ºæ…§ä¸‹è¼‰é‚è¼¯ ---
    if (currentMode === 'merge' || (currentMode === 'split' && rowsSetting === 0)) {
        // å–®ä¸€æª”æ¡ˆæƒ…æ³ï¼šç›´æ¥ä¸‹è¼‰ XLSX
        log.innerHTML += `\nå–®æª”å°å‡ºä¸­... (å…± ${total} ç­†)`;
        const buffer = generateExcelBuffer(finalHeaders, combinedBody);
        const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
        saveAs(blob, `${dateStr}_${total}.xlsx`);
        log.innerHTML += `\nâœ¨ å®Œæˆä¸‹è¼‰ï¼š${dateStr}_${total}.xlsx`;
    } else {
        // å¤šæª”æ¡ˆæƒ…æ³ï¼šåˆ†å‰²ä¸¦æ‰“åŒ… ZIP
        const zip = new JSZip();
        let count = 0;
        for (let i = 0; i < total; i += rowsSetting) {
            count++;
            const chunk = combinedBody.slice(i, i + rowsSetting);
            const buffer = generateExcelBuffer(finalHeaders, chunk);
            zip.file(`${dateStr}_${rowsSetting}_${count}.xlsx`, buffer);
        }
        
        if (count === 1) {
            // å¦‚æœåˆ†å‰²å®Œç™¼ç¾åªæœ‰ä¸€æª”ï¼Œä¹Ÿç›´æ¥ä¸‹è¼‰ XLSX
            const buffer = generateExcelBuffer(finalHeaders, combinedBody);
            const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
            saveAs(blob, `${dateStr}_${total}.xlsx`);
        } else {
            log.innerHTML += `\nå¤šæª”æ‰“åŒ…ä¸­... (å…± ${count} ä»½)`;
            const content = await zip.generateAsync({ type: "blob" });
            saveAs(content, `${dateStr}_split_${total}.zip`);
        }
        log.innerHTML += `\nâœ¨ å®Œæˆè™•ç†ï¼`;
    }
}
</script>

</body>
</html>
