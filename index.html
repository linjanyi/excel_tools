<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Excel æ•´ç†å·¥å…· - æ•´åˆ—å»é‡ç‰ˆ</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: #f0f2f5; padding: 40px; }
        .card { max-width: 550px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        h2 { color: #007bff; text-align: center; margin-bottom: 25px; }
        .field-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        input[type="number"], input[type="file"] { width: 100%; padding: 12px; border: 1px solid #ccd0d5; border-radius: 8px; box-sizing: border-box; }
        .row { display: flex; gap: 15px; }
        .row .field-group { flex: 1; }
        .checkbox-group { display: flex; align-items: center; background: #e9ecef; padding: 12px 15px; border-radius: 8px; margin-bottom: 20px; cursor: pointer; }
        .checkbox-group input { width: 20px; height: 20px; margin-right: 10px; cursor: pointer; }
        .checkbox-group label { margin-bottom: 0; cursor: pointer; color: #444; flex: 1; font-weight: bold; }
        button { width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background: #218838; }
        #log { margin-top: 20px; font-size: 14px; color: #444; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #28a745; white-space: pre-line; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ“Š Excel åˆ†å‰²å»é‡å·¥å…·</h2>
    
    <div class="field-group">
        <label>1. ä¸Šå‚³æª”æ¡ˆ</label>
        <input type="file" id="upload" accept=".xlsx, .xls" />
    </div>
    
    <div class="row">
        <div class="field-group">
            <label>2. ä¿ç•™æ¨™é¡Œåˆ—æ•¸</label>
            <input type="number" id="headerRows" value="2" min="1" />
        </div>
        <div class="field-group">
            <label>3. æ¯ä»½ç­†æ•¸ (0=ä¸åˆ†å‰²)</label>
            <input type="number" id="rowsPerFile" value="0" min="0" />
        </div>
    </div>

    <div class="checkbox-group" onclick="document.getElementById('doUnique').click();">
        <input type="checkbox" id="doUnique" checked onclick="event.stopPropagation();">
        <label for="doUnique">è‡ªå‹•å»é™¤é‡è¤‡ (æ•´åˆ—å…§å®¹å®Œå…¨ç›¸åŒæ‰åˆªé™¤)</label>
    </div>
    
    <button onclick="processExcel()">é–‹å§‹è™•ç†ä¸¦ä¸‹è¼‰</button>
    
    <div id="log">ç­‰å¾…æ“ä½œä¸­...</div>
</div>

<script>
function getMMDD() {
    const now = new Date();
    const m = String(now.getMonth() + 1).padStart(2, '0');
    const d = String(now.getDate()).padStart(2, '0');
    return m + d;
}

// æ•´åˆ—å»é‡é‚è¼¯
function removeDuplicates(dataArray) {
    const seen = new Set();
    return dataArray.filter(row => {
        // å°‡æ•´åˆ—è½‰æ›æˆå­—ä¸²ä½œç‚ºå”¯ä¸€ Key (è™•ç†æ—¥æœŸèˆ‡æ•¸å€¼çš„ç²¾ç¢ºæ¯”å°)
        const rowString = JSON.stringify(row);
        if (seen.has(rowString)) return false;
        seen.add(rowString);
        return true;
    });
}

async function processExcel() {
    const fileInput = document.getElementById('upload');
    const headerRowsSetting = parseInt(document.getElementById('headerRows').value) || 0;
    const rowsVal = document.getElementById('rowsPerFile').value;
    const doUnique = document.getElementById('doUnique').checked;
    const log = document.getElementById('log');
    
    if (!fileInput.files[0]) { alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼"); return; }

    log.innerHTML = "âŒ› è®€å–æª”æ¡ˆä¸­...";
    const file = fileInput.files[0];
    const rowsSetting = parseInt(rowsVal) || 0; 
    const dateStr = getMMDD();
    
    const data = await file.arrayBuffer();
    const workbook = XLSX.read(data);
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    const headers = jsonData.slice(0, headerRowsSetting);
    let body = jsonData.slice(headerRowsSetting);

    if
